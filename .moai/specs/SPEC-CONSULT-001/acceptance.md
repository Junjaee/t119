# SPEC-CONSULT-001 수락 기준

## 개요

실시간 상담 시스템의 완료 조건을 Given-When-Then 형식으로 정의합니다.

---

## 기능 검증 시나리오

### 1. 실시간 메시지 전송

#### Scenario 1.1: 메시지 전송 성공
```gherkin
Given 교사와 변호사가 매칭되어 상담방에 입장한 상태
  And 교사가 "안녕하세요, 학교폭력 상담 부탁드립니다" 메시지를 입력
When 교사가 전송 버튼을 클릭
Then 메시지가 1초 이내 변호사에게 전달되어야 함
  And 메시지가 데이터베이스에 저장되어야 함
  And 교사 화면에 전송 완료 표시가 나타나야 함
```

#### Scenario 1.2: 메시지 길이 초과
```gherkin
Given 교사가 5000자를 초과하는 긴 메시지를 입력
When 교사가 전송 버튼을 클릭
Then 전송이 거부되어야 함
  And "메시지는 5000자를 초과할 수 없습니다" 에러 메시지가 표시되어야 함
```

#### Scenario 1.3: 인증되지 않은 사용자
```gherkin
Given 사용자가 로그아웃 상태
When 사용자가 상담방 URL에 직접 접근
Then 접근이 거부되어야 함
  And 로그인 페이지로 리디렉션되어야 함
```

---

### 2. 파일 첨부

#### Scenario 2.1: 파일 업로드 성공
```gherkin
Given 교사가 상담방에 입장한 상태
  And 3MB 크기의 PDF 파일을 선택
When 교사가 파일 첨부 버튼을 클릭
Then 업로드 진행률이 표시되어야 함
  And 10초 이내 업로드가 완료되어야 함
  And 메시지에 파일이 첨부되어 전송되어야 함
  And 변호사가 첨부 파일을 다운로드할 수 있어야 함
```

#### Scenario 2.2: 파일 크기 초과
```gherkin
Given 교사가 7MB 크기의 이미지 파일을 선택
When 교사가 파일 첨부 버튼을 클릭
Then 업로드가 거부되어야 함
  And "파일 크기는 5MB를 초과할 수 없습니다" 에러가 표시되어야 함
```

#### Scenario 2.3: 파일 개수 초과
```gherkin
Given 교사가 이미 5개 파일을 첨부한 상태
When 교사가 추가로 파일을 선택
Then 첨부가 거부되어야 함
  And "최대 5개까지 첨부 가능합니다" 에러가 표시되어야 함
```

#### Scenario 2.4: 허용되지 않은 파일 형식
```gherkin
Given 교사가 .exe 실행 파일을 선택
When 교사가 파일 첨부 버튼을 클릭
Then 업로드가 거부되어야 함
  And "허용되지 않은 파일 형식입니다" 에러가 표시되어야 함
```

---

### 3. 읽음 상태 관리

#### Scenario 3.1: 읽음 상태 업데이트
```gherkin
Given 교사가 변호사에게 메시지를 전송한 상태
  And 변호사가 상담방에 입장하지 않은 상태
When 변호사가 상담방에 입장하여 메시지를 조회
Then 메시지가 "읽음" 상태로 변경되어야 함
  And 교사 화면에 "읽음" 표시가 1초 이내 나타나야 함
```

#### Scenario 3.2: 안읽은 메시지 카운트
```gherkin
Given 교사가 변호사에게 3개 메시지를 전송한 상태
  And 변호사가 아직 읽지 않은 상태
When 변호사가 상담 목록을 조회
Then 해당 상담방에 "안읽음 3" 배지가 표시되어야 함
```

---

### 4. 온라인 상태 표시

#### Scenario 4.1: 온라인 상태 변경
```gherkin
Given 교사가 상담방에 입장한 상태
When 변호사가 상담방에 입장
Then 교사 화면에 "변호사님이 입장하셨습니다" 표시가 나타나야 함
  And 변호사 프로필에 "온라인" 표시가 나타나야 함
```

#### Scenario 4.2: 입력 중 표시
```gherkin
Given 교사와 변호사가 모두 상담방에 있는 상태
When 교사가 메시지를 입력 중
Then 변호사 화면에 "교사님이 입력 중..." 표시가 500ms 이내 나타나야 함
  And 교사가 입력을 멈추면 표시가 사라져야 함
```

---

### 5. 네트워크 장애 처리

#### Scenario 5.1: 메시지 재전송
```gherkin
Given 교사가 메시지를 전송하려는 상태
  And 네트워크 연결이 불안정한 상태
When 교사가 전송 버튼을 클릭하고 전송이 실패
Then 시스템이 자동으로 재전송을 시도해야 함
  And 최대 3회까지 재전송을 시도해야 함
  And 재전송 간격은 1초, 2초, 4초(지수 백오프)여야 함
  And 3회 실패 시 사용자에게 에러 메시지가 표시되어야 함
```

#### Scenario 5.2: 연결 끊김 및 재연결
```gherkin
Given 교사가 상담 중인 상태
When 네트워크 연결이 끊어짐
Then "연결이 끊어졌습니다" 알림이 표시되어야 함
  And 시스템이 자동으로 재연결을 시도해야 함
When 네트워크가 복구되면
Then "다시 연결되었습니다" 알림이 표시되어야 함
  And 누락된 메시지가 5초 이내 동기화되어야 함
```

---

### 6. 메시지 이력 조회

#### Scenario 6.1: 이전 메시지 로딩
```gherkin
Given 교사와 변호사가 100개 이상의 메시지를 주고받은 상태
When 교사가 상담방에 입장
Then 최근 50개 메시지가 2초 이내 로딩되어야 함
When 교사가 스크롤을 최상단으로 이동
Then 이전 50개 메시지가 1초 이내 로딩되어야 함
```

#### Scenario 6.2: 메시지 검색 (선택 기능)
```gherkin
Given 교사가 상담방에서 "학교폭력" 키워드로 검색
When 검색 버튼을 클릭
Then 해당 키워드를 포함한 메시지 목록이 표시되어야 함
  And 검색 결과가 1초 이내 표시되어야 함
```

---

## 성능 검증 시나리오

### Performance 1: 메시지 전송 지연
```gherkin
Given 교사와 변호사가 상담 중인 상태
When 교사가 메시지를 전송
Then 변호사가 메시지를 수신하기까지 1초를 초과하지 않아야 함
```

### Performance 2: 파일 업로드 속도
```gherkin
Given 교사가 5MB PDF 파일을 첨부
When 업로드를 시작
Then 10초 이내 업로드가 완료되어야 함
```

### Performance 3: 초기 로딩 속도
```gherkin
Given 교사가 상담방 URL에 접근
When 페이지 로딩 시작
Then 메시지 목록이 2초 이내 표시되어야 함
```

---

## 보안 검증 시나리오

### Security 1: 권한 검증
```gherkin
Given 교사A와 변호사B가 매칭된 상태
  And 교사C가 다른 사용자
When 교사C가 교사A-변호사B 상담방 URL에 접근 시도
Then 접근이 거부되어야 함
  And "권한이 없습니다" 에러가 표시되어야 함
```

### Security 2: XSS 방지
```gherkin
Given 악의적 사용자가 "<script>alert('XSS')</script>" 메시지를 전송
When 메시지가 수신자 화면에 표시될 때
Then 스크립트가 실행되지 않아야 함
  And HTML 이스케이프된 텍스트로 표시되어야 함
```

### Security 3: 파일 검증
```gherkin
Given 악의적 사용자가 .jpg로 위장한 .exe 파일을 업로드 시도
When 서버에서 MIME 타입을 검증
Then 업로드가 거부되어야 함
  And "허용되지 않은 파일입니다" 에러가 표시되어야 함
```

---

## 완료 조건 (Definition of Done)

### 기능 완료
- [ ] 모든 EARS 요구사항이 구현됨
- [ ] 모든 Given-When-Then 시나리오가 통과함
- [ ] 단위 테스트 커버리지 85% 이상
- [ ] 통합 테스트 모든 시나리오 통과

### 성능 완료
- [ ] 메시지 전송 지연 1초 이내
- [ ] 파일 업로드 10초 이내 (5MB 기준)
- [ ] 초기 로딩 2초 이내
- [ ] 메시지 동기화 5초 이내

### 보안 완료
- [ ] JWT 인증 검증 100%
- [ ] RLS 정책 적용 완료
- [ ] XSS 방지 테스트 통과
- [ ] 파일 MIME 타입 검증 완료

### 문서 완료
- [ ] Living Document 동기화 완료
- [ ] @TAG 체인 검증 완료
- [ ] API 문서 작성 완료
- [ ] 사용자 가이드 작성 완료

---

## 품질 게이트

### Critical (차단 기준)
- 메시지 전송/수신 실패
- 파일 업로드 실패
- 인증 우회 가능
- XSS 공격 가능

### High (수정 필요)
- 성능 기준 미달 (지연 2초 이상)
- 재전송 로직 실패
- 에러 메시지 부재

### Medium (개선 권장)
- UI 피드백 지연
- 로딩 스피너 누락
- 접근성 이슈

---

## 검증 방법

### 자동화 테스트
```bash
# 단위 테스트
npm run test:unit

# 통합 테스트
npm run test:integration

# E2E 테스트
npm run test:e2e

# 커버리지 확인
npm run test:coverage
```

### 수동 테스트
1. 교사/변호사 각각 로그인
2. 실시간 메시지 송수신 확인
3. 파일 첨부 및 다운로드
4. 네트워크 끊김 시뮬레이션 (개발자 도구)
5. 읽음 상태 변경 확인
6. 온라인 상태 표시 확인

---

**문서 버전**: v0.0.1
**최종 수정일**: 2025-10-20
**작성자**: @Goos
